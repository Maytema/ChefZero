import express from 'express';
import cors from 'cors';
import path from 'path';
import { fileURLToPath } from 'url';
import { GoogleGenerativeAI } from '@google/generative-ai';
import dotenv from 'dotenv';

dotenv.config();

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 3000;

// ะะฝะธัะธะฐะปะธะทะฐัะธั Gemini API
let geminiAvailable = false;
let genAI;

if (process.env.GEMINI_API_KEY) {
    try {
        genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
        geminiAvailable = true;
        console.log('โ Gemini API ะฟะพะดะบะปััะตะฝ');
    } catch (error) {
        console.error('โ ะัะธะฑะบะฐ ะฟะพะดะบะปััะตะฝะธั Gemini API:', error);
    }
} else {
    console.warn('โ๏ธ  GEMINI_API_KEY ะฝะต ัะบะฐะทะฐะฝ. ะะ-ัะตัะตะฟัั ะฝะต ะฑัะดัั ัะฐะฑะพัะฐัั.');
}

app.use(cors());
app.use(express.json());
app.use(express.static(path.join(__dirname, 'public')));

// ะััะฟะฟะธัะพะฒะฐะฝะฝัะต ะฟัะพะดัะบัั ะฟะพ ะบะฐัะตะณะพัะธัะผ (ะฟะพะปะฝัะน ัะฟะธัะพะบ)
const PRODUCTS_BY_CATEGORY = {
    "ะะฐะทะพะฒัะต": [
        {id: 1, name: "ัะนัะฐ", icon: "๐ฅ"},
        {id: 2, name: "ะผัะบะฐ", icon: "๐พ"},
        {id: 3, name: "ัะฐัะฐั", icon: "๐ฌ"},
        {id: 4, name: "ัะพะปั", icon: "๐ง"},
        {id: 5, name: "ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต", icon: "๐ซ"},
        {id: 6, name: "ะผะฐัะปะพ ัะปะธะฒะพัะฝะพะต", icon: "๐ง"},
        {id: 7, name: "ะฒะพะดะฐ", icon: "๐ง"},
        {id: 8, name: "ัะบััั", icon: "๐ถ"},
        {id: 9, name: "ัะพะดะฐ", icon: "๐ง"},
        {id: 10, name: "ะดัะพะถะถะธ", icon: "๐งซ"}
    ],
    "ะะฒะพัะธ": [
        {id: 11, name: "ะบะฐััะพัะตะปั", icon: "๐ฅ"},
        {id: 12, name: "ะปัะบ", icon: "๐ง"},
        {id: 13, name: "ะผะพัะบะพะฒั", icon: "๐ฅ"},
        {id: 14, name: "ะฟะพะผะธะดะพัั", icon: "๐"},
        {id: 15, name: "ะพะณัััั", icon: "๐ฅ"},
        {id: 16, name: "ะบะฐะฟัััะฐ", icon: "๐ฅฌ"},
        {id: 17, name: "ัะตัะฝะพะบ", icon: "๐ง"},
        {id: 18, name: "ะฟะตัะตั", icon: "๐ซ"},
        {id: 19, name: "ะทะตะปะตะฝั", icon: "๐ฟ"},
        {id: 20, name: "ะฑะฐะบะปะฐะถะฐะฝั", icon: "๐"}
    ],
    "ะะพะปะพัะฝัะต": [
        {id: 21, name: "ะผะพะปะพะบะพ", icon: "๐ฅ"},
        {id: 22, name: "ัะผะตัะฐะฝะฐ", icon: "๐ฅฃ"},
        {id: 23, name: "ััั", icon: "๐ง"},
        {id: 24, name: "ัะฒะพัะพะณ", icon: "๐ฅฃ"},
        {id: 25, name: "ะบะตัะธั", icon: "๐ฅ"},
        {id: 26, name: "ะนะพะณััั", icon: "๐ฅ"},
        {id: 27, name: "ัะปะธะฒะบะธ", icon: "๐ถ"},
        {id: 28, name: "ะผะฐะนะพะฝะตะท", icon: "๐ถ"},
        {id: 29, name: "ัะณััะตะฝะบะฐ", icon: "๐ฅซ"}
    ],
    "ะััะพ ะธ ะฟัะธัะฐ": [
        {id: 30, name: "ะบััะธัะฐ", icon: "๐"},
        {id: 31, name: "ะณะพะฒัะดะธะฝะฐ", icon: "๐ฅฉ"},
        {id: 32, name: "ัะฒะธะฝะธะฝะฐ", icon: "๐ท"},
        {id: 33, name: "ะธะฝะดะตะนะบะฐ", icon: "๐ฆ"},
        {id: 34, name: "ัะฐัั", icon: "๐ฅฉ"},
        {id: 35, name: "ะบะพะปะฑะฐัะฐ", icon: "๐ญ"},
        {id: 36, name: "ัะพัะธัะบะธ", icon: "๐ญ"},
        {id: 37, name: "ะฑะตะบะพะฝ", icon: "๐ฅ"}
    ],
    "ะัะฑะฐ ะธ ะผะพัะตะฟัะพะดัะบัั": [
        {id: 38, name: "ััะฑะฐ", icon: "๐"},
        {id: 39, name: "ะปะพัะพัั", icon: "๐"},
        {id: 40, name: "ััะฝะตั", icon: "๐"},
        {id: 41, name: "ะบัะตะฒะตัะบะธ", icon: "๐ฆ"},
        {id: 42, name: "ะบะฐะปัะผะฐัั", icon: "๐ฆ"},
        {id: 43, name: "ะผะธะดะธะธ", icon: "๐ฆช"},
        {id: 44, name: "ะธะบัะฐ", icon: "๐ฅซ"}
    ],
    "ะััะฟั ะธ ะผะฐะบะฐัะพะฝั": [
        {id: 45, name: "ัะธั", icon: "๐"},
        {id: 46, name: "ะณัะตัะบะฐ", icon: "๐พ"},
        {id: 47, name: "ะผะฐะบะฐัะพะฝั", icon: "๐"},
        {id: 48, name: "ะพะฒััะฝะบะฐ", icon: "๐ฅฃ"},
        {id: 49, name: "ะฟัะตะฝะพ", icon: "๐พ"},
        {id: 50, name: "ะฟะตัะปะพะฒะบะฐ", icon: "๐พ"},
        {id: 51, name: "ะผะฐะฝะบะฐ", icon: "๐พ"},
        {id: 52, name: "ะบััะบัั", icon: "๐"}
    ],
    "ะคััะบัั ะธ ัะณะพะดั": [
        {id: 53, name: "ัะฑะปะพะบะธ", icon: "๐"},
        {id: 54, name: "ะฑะฐะฝะฐะฝั", icon: "๐"},
        {id: 55, name: "ะฐะฟะตะปััะธะฝั", icon: "๐"},
        {id: 56, name: "ะปะธะผะพะฝ", icon: "๐"},
        {id: 57, name: "ะบะปัะฑะฝะธะบะฐ", icon: "๐"},
        {id: 58, name: "ะฒะธะฝะพะณัะฐะด", icon: "๐"},
        {id: 59, name: "ะฟะตััะธะบะธ", icon: "๐"},
        {id: 60, name: "ะบะธะฒะธ", icon: "๐ฅ"},
        {id: 61, name: "ะฐะฝะฐะฝะฐั", icon: "๐"},
        {id: 62, name: "ะฐัะฑัะท", icon: "๐"}
    ],
    "ะกะพััั ะธ ัะฟะตัะธะธ": [
        {id: 63, name: "ะบะตัััะฟ", icon: "๐"},
        {id: 64, name: "ะณะพััะธัะฐ", icon: "๐ญ"},
        {id: 65, name: "ัะพัั ัะพะตะฒัะน", icon: "๐ถ"},
        {id: 66, name: "ะฟะตัะตั ัะตัะฝัะน", icon: "โซ"},
        {id: 67, name: "ะฟะฐะฟัะธะบะฐ", icon: "๐ถ๏ธ"},
        {id: 68, name: "ะปะฐะฒัะพะฒัะน ะปะธัั", icon: "๐ฟ"},
        {id: 69, name: "ะบะฐััะธ", icon: "๐ก"},
        {id: 70, name: "ะธะผะฑะธัั", icon: "๐ฟ"}
    ],
    "ะฅะปะตะฑ ะธ ะฒัะฟะตัะบะฐ": [
        {id: 71, name: "ัะปะตะฑ", icon: "๐"},
        {id: 72, name: "ะฑะฐัะพะฝ", icon: "๐ฅ"},
        {id: 73, name: "ะปะฐะฒะฐั", icon: "๐ซ"},
        {id: 74, name: "ะฑัะปะพัะบะธ", icon: "๐ฅ"},
        {id: 75, name: "ัััะฐัะธ", icon: "๐"},
        {id: 76, name: "ะฟะตัะตะฝัะต", icon: "๐ช"}
    ]
};

// ะะตัะตะฟัั ะฑะฐะทะฐ ะดะฐะฝะฝัั
const RECIPES_DB = [
    {
        id: 1,
        name: "ะะผะปะตั ั ะพะฒะพัะฐะผะธ",
        ingredients: ["ัะนัะฐ", "ะฟะพะผะธะดะพัั", "ะปัะบ", "ััั"],
        time: "15 ะผะธะฝ",
        difficulty: "ะปะตะณะบะพ",
        steps: [
            "ะะทะฑะตะนัะต ัะนัะฐ ะฒ ะผะธัะบะต ั ัะตะฟะพัะบะพะน ัะพะปะธ",
            "ะะฐัะตะถััะต ะฟะพะผะธะดะพัั ะบัะฑะธะบะฐะผะธ, ะปัะบ - ะฟะพะปัะบะพะปััะฐะผะธ",
            "ะะฑะถะฐัััะต ะปัะบ ะฝะฐ ัะฐััะธัะตะปัะฝะพะผ ะผะฐัะปะต 2-3 ะผะธะฝััั",
            "ะะพะฑะฐะฒััะต ะฟะพะผะธะดะพัั, ะถะฐัััะต ะตัั 3 ะผะธะฝััั",
            "ะะฐะปะตะนัะต ัะนัะฐะผะธ, ะณะพัะพะฒััะต ะฝะฐ ััะตะดะฝะตะผ ะพะณะฝะต 5-7 ะผะธะฝัั",
            "ะะพััะฟััะต ัะตัััะผ ัััะพะผ ะฟะตัะตะด ะฟะพะดะฐัะตะน"
        ]
    },
    {
        id: 2,
        name: "ะะฐััะพัะตะปั ั ะบััะธัะตะน ะฒ ะดััะพะฒะบะต",
        ingredients: ["ะบะฐััะพัะตะปั", "ะบััะธัะฐ", "ะปัะบ", "ะผะพัะบะพะฒั", "ัะผะตัะฐะฝะฐ"],
        time: "45 ะผะธะฝ",
        difficulty: "ััะตะดะฝะต",
        steps: [
            "ะะฐััะพัะตะปั ะธ ะบััะธัั ะฝะฐัะตะถััะต ะบัะฑะธะบะฐะผะธ",
            "ะัะบ ะธ ะผะพัะบะพะฒั ะฝะฐัะตะถััะต ะฟะพะปัะบะพะปััะฐะผะธ",
            "ะะฑะถะฐัััะต ะปัะบ ะธ ะผะพัะบะพะฒั 5 ะผะธะฝัั ะดะพ ะผัะณะบะพััะธ",
            "ะกะผะตัะฐะนัะต ะฒัะต ะธะฝะณัะตะดะธะตะฝัั ัะพ ัะผะตัะฐะฝะพะน, ะฟะพัะพะปะธัะต, ะฟะพะฟะตััะธัะต",
            "ะัะปะพะถะธัะต ะฒ ัะพัะผั ะดะปั ะทะฐะฟะตะบะฐะฝะธั",
            "ะะฐะฟะตะบะฐะนัะต 30-35 ะผะธะฝัั ะฟัะธ 180ยฐC ะดะพ ะทะพะปะพัะธััะพะน ะบะพัะพัะบะธ"
        ]
    },
    {
        id: 3,
        name: "ะกะฐะปะฐั ะธะท ัะฒะตะถะธั ะพะฒะพัะตะน",
        ingredients: ["ะฟะพะผะธะดะพัั", "ะพะณัััั", "ะฟะตัะตั", "ะปัะบ", "ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต"],
        time: "10 ะผะธะฝ",
        difficulty: "ะพัะตะฝั ะปะตะณะบะพ",
        steps: [
            "ะะพะผะธะดะพัั ะธ ะพะณัััั ะฝะฐัะตะถััะต ะบัะฑะธะบะฐะผะธ",
            "ะะตัะตั ะฝะฐัะตะถััะต ัะพะปะพะผะบะพะน, ะปัะบ - ะฟะพะปัะบะพะปััะฐะผะธ",
            "ะกะผะตัะฐะนัะต ะฒัะต ะพะฒะพัะธ ะฒ ัะฐะปะฐัะฝะธัะต",
            "ะะฐะฟัะฐะฒััะต ัะฐััะธัะตะปัะฝัะผ ะผะฐัะปะพะผ, ะฟะพัะพะปะธัะต ะฟะพ ะฒะบััั",
            "ะะพะถะฝะพ ะดะพะฑะฐะฒะธัั ัะฒะตะถัั ะทะตะปะตะฝั"
        ]
    },
    {
        id: 4,
        name: "ะะฐััะฐ ั ัััะพะผ",
        ingredients: ["ะผะฐะบะฐัะพะฝั", "ััั", "ัะปะธะฒะบะธ", "ัะตัะฝะพะบ"],
        time: "20 ะผะธะฝ",
        difficulty: "ะปะตะณะบะพ",
        steps: [
            "ะัะฒะฐัะธัะต ะผะฐะบะฐัะพะฝั ัะพะณะปะฐัะฝะพ ะธะฝััััะบัะธะธ ะฝะฐ ัะฟะฐะบะพะฒะบะต",
            "ะะฐััะธัะต ััั ะฝะฐ ะผะตะปะบะพะน ัะตัะบะต",
            "ะะฐะทะพะณัะตะนัะต ัะปะธะฒะบะธ ะฒ ัะพัะตะนะฝะธะบะต, ะดะพะฑะฐะฒััะต ะธะทะผะตะปััะตะฝะฝัะน ัะตัะฝะพะบ",
            "ะะพะฑะฐะฒััะต ะฟะพะปะพะฒะธะฝั ัััะฐ ะฒ ัะปะธะฒะบะธ, ะฟะพะผะตัะธะฒะฐะนัะต ะดะพ ัะฐััะฒะพัะตะฝะธั",
            "ะกะผะตัะฐะนัะต ะผะฐะบะฐัะพะฝั ั ัะพััะพะผ",
            "ะะพััะฟััะต ะพััะฐะฒัะธะผัั ัััะพะผ ะธ ะฟะพะดะฐะฒะฐะนัะต"
        ]
    },
    {
        id: 5,
        name: "ะะฐัะตะฝะฐั ะบะฐััะพัะบะฐ ั ะณัะธะฑะฐะผะธ",
        ingredients: ["ะบะฐััะพัะตะปั", "ะปัะบ", "ะณัะธะฑั", "ะผะฐัะปะพ ัะฐััะธัะตะปัะฝะพะต"],
        time: "25 ะผะธะฝ",
        difficulty: "ะปะตะณะบะพ",
        steps: [
            "ะะฐััะพัะตะปั ะฝะฐัะตะถััะต ัะพะฝะบะธะผะธ ะปะพะผัะธะบะฐะผะธ",
            "ะัะบ ะฝะฐัะตะถััะต ะฟะพะปัะบะพะปััะฐะผะธ, ะณัะธะฑั - ะฟะปะฐััะธะฝะบะฐะผะธ",
            "ะะฑะถะฐัััะต ะปัะบ ะดะพ ะฟัะพะทัะฐัะฝะพััะธ 3-4 ะผะธะฝััั",
            "ะะพะฑะฐะฒััะต ะณัะธะฑั, ะถะฐัััะต 5-7 ะผะธะฝัั ะดะพ ะณะพัะพะฒะฝะพััะธ",
            "ะะพะฑะฐะฒััะต ะบะฐััะพัะตะปั, ะถะฐัััะต 15 ะผะธะฝัั ะฝะฐ ััะตะดะฝะตะผ ะพะณะฝะต",
            "ะะพัะพะปะธัะต, ะฟะพะฟะตััะธัะต, ะฟะพะดะฐะฒะฐะนัะต ะณะพัััะธะผ"
        ]
    },
    {
        id: 6,
        name: "ะััะธะฝัะน ััะฟ",
        ingredients: ["ะบััะธัะฐ", "ะบะฐััะพัะตะปั", "ะผะพัะบะพะฒั", "ะปัะบ", "ะปะฐะฟัะฐ"],
        time: "40 ะผะธะฝ",
        difficulty: "ะปะตะณะบะพ",
        steps: [
            "ะััะธัั ะทะฐะปะตะนัะต ะฒะพะดะพะน, ะฒะฐัะธัะต 20 ะผะธะฝัั",
            "ะะพะฑะฐะฒััะต ะฝะฐัะตะทะฐะฝะฝัะน ะบะฐััะพัะตะปั ะบัะฑะธะบะฐะผะธ",
            "ะะพัะบะพะฒั ะฝะฐััะธัะต ะฝะฐ ัะตัะบะต, ะปัะบ ะผะตะปะบะพ ะฝะฐัะตะถััะต",
            "ะะฑะถะฐัััะต ะปัะบ ะธ ะผะพัะบะพะฒั 5 ะผะธะฝัั, ะดะพะฑะฐะฒััะต ะฒ ััะฟ",
            "ะะฐัะธัะต 10 ะผะธะฝัั, ะทะฐัะตะผ ะดะพะฑะฐะฒััะต ะปะฐะฟัั",
            "ะะฐัะธัะต ะตัั 5 ะผะธะฝัั, ะฟะพะดะฐะฒะฐะนัะต ั ะทะตะปะตะฝัั"
        ]
    },
    {
        id: 7,
        name: "ะัะตัะบะฐ ั ะบััะธัะตะน",
        ingredients: ["ะณัะตัะบะฐ", "ะบััะธัะฐ", "ะปัะบ", "ะผะพัะบะพะฒั"],
        time: "30 ะผะธะฝ",
        difficulty: "ะปะตะณะบะพ",
        steps: [
            "ะัะตัะบั ะฟัะพะผะพะนัะต ะธ ะพัะฒะฐัะธัะต ะดะพ ะณะพัะพะฒะฝะพััะธ",
            "ะััะธัั ะฝะฐัะตะถััะต ะบัะฑะธะบะฐะผะธ, ะพะฑะถะฐัััะต 10 ะผะธะฝัั",
            "ะัะบ ะธ ะผะพัะบะพะฒั ะฝะฐัะตะถััะต, ะพะฑะถะฐัััะต ะดะพ ะผัะณะบะพััะธ",
            "ะกะผะตัะฐะนัะต ะณัะตัะบั ั ะบััะธัะตะน ะธ ะพะฒะพัะฐะผะธ",
            "ะะพัััะธัะต ะฟะพะด ะบัััะบะพะน 5-7 ะผะธะฝัั"
        ]
    },
    {
        id: 8,
        name: "ะะธั ั ะพะฒะพัะฐะผะธ",
        ingredients: ["ัะธั", "ะผะพัะบะพะฒั", "ะปัะบ", "ะฟะตัะตั", "ะณะพัะพัะตะบ"],
        time: "25 ะผะธะฝ",
        difficulty: "ะปะตะณะบะพ",
        steps: [
            "ะะธั ะพัะฒะฐัะธัะต ะดะพ ะณะพัะพะฒะฝะพััะธ",
            "ะะฒะพัะธ ะฝะฐัะตะถััะต ะบัะฑะธะบะฐะผะธ",
            "ะะฑะถะฐัััะต ะปัะบ ะธ ะผะพัะบะพะฒั 5 ะผะธะฝัั",
            "ะะพะฑะฐะฒััะต ะฟะตัะตั ะธ ะณะพัะพัะตะบ, ะถะฐัััะต 5 ะผะธะฝัั",
            "ะกะผะตัะฐะนัะต ั ัะธัะพะผ, ะฟะพัะพะปะธัะต ะฟะพ ะฒะบััั"
        ]
    }
];

// API: ะะพะปััะธัั ะฒัะต ะฟัะพะดัะบัั
app.get('/api/products', (req, res) => {
    res.json({ 
        success: true, 
        categories: PRODUCTS_BY_CATEGORY 
    });
});

// API: ะะพะธัะบ ัะตัะตะฟัะพะฒ
app.post('/api/find-recipes', (req, res) => {
    const { ingredients } = req.body;
    
    if (!ingredients || !Array.isArray(ingredients)) {
        return res.json({ success: false, error: "ะะตั ะธะฝะณัะตะดะธะตะฝัะพะฒ" });
    }
    
    const matchedRecipes = RECIPES_DB.filter(recipe => {
        const matches = recipe.ingredients.filter(ing => 
            ingredients.some(userIng => {
                const userIngLower = userIng.toLowerCase();
                const recipeIngLower = ing.toLowerCase();
                return recipeIngLower.includes(userIngLower) || 
                       userIngLower.includes(recipeIngLower);
            })
        ).length;
        
        return matches >= Math.min(2, recipe.ingredients.length);
    });
    
    res.json({ 
        success: true, 
        recipes: matchedRecipes.slice(0, 8),
        count: matchedRecipes.length 
    });
});

// API: ะะตะฝะตัะฐัะธั ะะ-ัะตัะตะฟัะพะฒ ั ัะตะฐะปัะฝัะผ Gemini
app.post('/api/generate-ai-recipes', async (req, res) => {
    try {
        if (!geminiAvailable) {
            return res.json({ 
                success: false, 
                error: "ะะ-ัะตัะฒะธั ะฒัะตะผะตะฝะฝะพ ะฝะตะดะพัััะฟะตะฝ. ะะพะถะฐะปัะนััะฐ, ะฟะพะฟัะพะฑัะนัะต ะฟะพะทะถะต." 
            });
        }
        
        const { ingredients, maxRecipes = 2 } = req.body;
        
        if (!ingredients || !Array.isArray(ingredients) || ingredients.length === 0) {
            return res.json({ success: false, error: "ะะตั ะธะฝะณัะตะดะธะตะฝัะพะฒ ะดะปั ะณะตะฝะตัะฐัะธะธ ัะตัะตะฟัะฐ" });
        }
        
        console.log(`๐ฎ ะะตะฝะตัะธััะตะผ ะะ-ัะตัะตะฟั ะดะปั ะธะฝะณัะตะดะธะตะฝัะพะฒ: ${ingredients.join(', ')}`);
        
        const model = genAI.getGenerativeModel({ model: "gemini-pro" });
        
        const prompt = `
ะขั ะฟัะพัะตััะธะพะฝะฐะปัะฝัะน ะฟะพะฒะฐั. ะกะพะทะดะฐะน ${maxRecipes} ะฟัะพัััั ะธ ะฒะบััะฝัั ัะตัะตะฟัะฐ ะธัะฟะพะปัะทัั ะขะะะฌะะ ััะธ ะธะฝะณัะตะดะธะตะฝัั (ะผะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะฝะต ะฒัะต, ะฝะพ ะฝะต ะดะพะฑะฐะฒะปััั ะฝะพะฒัะต):
${ingredients.map((ing, i) => `${i+1}. ${ing}`).join('\n')}

ะคะะะฃะะฌะขะะขะะะะ ะะะะะ ะะกะะะะฌะะะะะขะฌ (ะตัะปะธ ะฝะต ัะบะฐะทะฐะฝั, ัะพ ะะ ะดะพะฑะฐะฒะปััั):
- ัะพะปั, ะฟะตัะตั, ัะฐััะธัะตะปัะฝะพะต ะผะฐัะปะพ, ะฒะพะดะฐ

ะขะะะะะะะะะฏ:
1. ะะตัะตะฟัั ะดะพะปะถะฝั ะฑััั ัะตะฐะปะธััะธัะฝัะผะธ ะธ ะฒัะฟะพะปะฝะธะผัะผะธ ะฝะฐ ะดะพะผะฐัะฝะตะน ะบััะฝะต
2. ะัะตะผั ะฟัะธะณะพัะพะฒะปะตะฝะธั ะฝะต ะฑะพะปะตะต 60 ะผะธะฝัั
3. ะัะพัััะต ะฟะพะฝััะฝัะต ัะฐะณะธ
4. ะขะพะปัะบะพ ััััะบะธะน ัะทัะบ
5. ะคะพัะผะฐั ะดะปั ะบะฐะถะดะพะณะพ ัะตัะตะฟัะฐ ัััะพะณะพ ัะฐะบะพะน:

ะะะะะะะะ: [ะะฐะทะฒะฐะฝะธะต ะฑะปัะดะฐ]
ะะะะะะะะะะขะซ: [ะกะฟะธัะพะบ ะธัะฟะพะปัะทัะตะผัั ะธะฝะณัะตะดะธะตะฝัะพะฒ ะธะท ะฟัะตะดะพััะฐะฒะปะตะฝะฝัั]
ะะะะะฏ: [ะัะตะผั ะฒ ะผะธะฝััะฐั] ะผะธะฝ
ะกะะะะะะกะขะฌ: [ะปะตะณะบะพ/ััะตะดะฝะต/ัะปะพะถะฝะพ]
ะจะะะ:
1. [ะะตัะฒัะน ัะฐะณ ะฟัะธะณะพัะพะฒะปะตะฝะธั]
2. [ะัะพัะพะน ัะฐะณ ะฟัะธะณะพัะพะฒะปะตะฝะธั]
3. [ะธ ัะฐะบ ะดะฐะปะตะต...]

ะัะธะผะตั ะฟัะฐะฒะธะปัะฝะพะณะพ ะพัะฒะตัะฐ:
ะะะะะะะะ: ะะผะปะตั ั ะฟะพะผะธะดะพัะฐะผะธ
ะะะะะะะะะะขะซ: ัะนัะฐ, ะฟะพะผะธะดะพัั, ัะพะปั, ัะฐััะธัะตะปัะฝะพะต ะผะฐัะปะพ
ะะะะะฏ: 15 ะผะธะฝ
ะกะะะะะะกะขะฌ: ะปะตะณะบะพ
ะจะะะ:
1. ะะทะฑะตะนัะต ัะนัะฐ ั ัะพะปัั
2. ะะฐัะตะถััะต ะฟะพะผะธะดะพัั ะบัะฑะธะบะฐะผะธ
3. ะะฑะถะฐัััะต ะฟะพะผะธะดะพัั 2 ะผะธะฝััั
4. ะะฐะปะตะนัะต ัะนัะฐะผะธ ะธ ะณะพัะพะฒััะต 5-7 ะผะธะฝัั

ะขะตะฟะตัั ัะพะทะดะฐะน ${maxRecipes} ัะตัะตะฟัะฐ ะฝะฐ ะพัะฝะพะฒะต ะฟัะตะดะพััะฐะฒะปะตะฝะฝัั ะธะฝะณัะตะดะธะตะฝัะพะฒ.
`;
        
        const result = await model.generateContent(prompt);
        const response = await result.response;
        const text = response.text();
        
        console.log('๐ ะะพะปััะตะฝ ะพัะฒะตั ะพั ะะ:', text.substring(0, 200) + '...');
        
        const aiRecipes = parseAIResponse(text);
        
        if (aiRecipes.length === 0) {
            throw new Error('ะะต ัะดะฐะปะพัั ัะณะตะฝะตัะธัะพะฒะฐัั ัะตัะตะฟั');
        }
        
        res.json({ 
            success: true, 
            recipes: aiRecipes,
            aiGenerated: true 
        });
        
    } catch (error) {
        console.error('โ ะัะธะฑะบะฐ ะณะตะฝะตัะฐัะธะธ ะะ-ัะตัะตะฟัะฐ:', error);
        
        // Fallback ัะตัะตะฟั ะตัะปะธ ะะ ะฝะตะดะพัััะฟะตะฝ
        const { ingredients } = req.body;
        const fallbackRecipe = createFallbackRecipe(ingredients);
        
        res.json({ 
            success: true, 
            recipes: [fallbackRecipe],
            aiGenerated: true,
            fallback: true
        });
    }
});

// ะคัะฝะบัะธั ะฟะฐััะธะฝะณะฐ ะพัะฒะตัะฐ ะะ
function parseAIResponse(text) {
    const recipes = [];
    const recipeBlocks = text.split(/\n\s*\n/);
    
    recipeBlocks.forEach(block => {
        const lines = block.split('\n').map(l => l.trim()).filter(l => l);
        let recipe = {
            name: '',
            ingredients: [],
            time: '',
            difficulty: '',
            steps: [],
            aiGenerated: true
        };
        
        let inSteps = false;
        
        for (let line of lines) {
            if (line.startsWith('ะะะะะะะะ:')) {
                recipe.name = line.replace('ะะะะะะะะ:', '').trim();
            } else if (line.startsWith('ะะะะะะะะะะขะซ:')) {
                const ingText = line.replace('ะะะะะะะะะะขะซ:', '').trim();
                recipe.ingredients = ingText.split(',').map(i => i.trim()).filter(i => i);
            } else if (line.startsWith('ะะะะะฏ:')) {
                recipe.time = line.replace('ะะะะะฏ:', '').trim();
            } else if (line.startsWith('ะกะะะะะะกะขะฌ:')) {
                recipe.difficulty = line.replace('ะกะะะะะะกะขะฌ:', '').trim().toLowerCase();
            } else if (line.startsWith('ะจะะะ:')) {
                inSteps = true;
            } else if (inSteps && line.match(/^\d+\./)) {
                recipe.steps.push(line.replace(/^\d+\./, '').trim());
            } else if (line === '') {
                inSteps = false;
            }
        }
        
        // ะะฐะปะธะดะฐัะธั ัะตัะตะฟัะฐ
        if (recipe.name && recipe.steps.length >= 2 && recipe.ingredients.length >= 2) {
            recipe.id = Date.now() + Math.floor(Math.random() * 1000);
            recipes.push(recipe);
        }
    });
    
    return recipes;
}

// Fallback ัะตัะตะฟั ะตัะปะธ ะะ ะฝะต ัะฐะฑะพัะฐะตั
function createFallbackRecipe(ingredients) {
    const mainIng = ingredients[0] || 'ะฟัะพะดัะบัั';
    return {
        id: Date.now(),
        name: `ะะปัะดะพ ะธะท ${mainIng}`,
        ingredients: ingredients.slice(0, 4),
        time: '25 ะผะธะฝ',
        difficulty: 'ะปะตะณะบะพ',
        steps: [
            'ะะพะดะณะพัะพะฒััะต ะฒัะต ะธะฝะณัะตะดะธะตะฝัั',
            'ะะฐัะตะถััะต ะพัะฝะพะฒะฝัะต ะบะพะผะฟะพะฝะตะฝัั',
            'ะะฑะถะฐัััะต ะธะปะธ ะพัะฒะฐัะธัะต ะฒ ะทะฐะฒะธัะธะผะพััะธ ะพั ัะธะฟะฐ ะธะฝะณัะตะดะธะตะฝัะพะฒ',
            'ะะพะฑะฐะฒััะต ัะฟะตัะธะธ ะฟะพ ะฒะบััั',
            'ะะพะดะฐะฒะฐะนัะต ะณะพัััะธะผ, ัะบัะฐัะธะฒ ะทะตะปะตะฝัั'
        ],
        aiGenerated: true,
        fallback: true
    };
}

// API: ะกะพะทะดะฐัั ะฟะปะฐัะตะถ (DonationAlerts)
app.post('/api/create-payment', (req, res) => {
    const { plan } = req.body;
    
    const plans = {
        '10recipes': {
            name: '10 ะดะพะฟะพะปะฝะธัะตะปัะฝัั ัะตัะตะฟัะพะฒ',
            price: 99,
            description: 'ะะฐะทะพะฒะพะต ะฟะพะฟะพะปะฝะตะฝะธะต ะฑะฐะปะฐะฝัะฐ ะะ-ัะตัะตะฟัะพะฒ'
        },
        'monthly': {
            name: 'ะะตัััะฝะฐั ะฟะพะดะฟะธัะบะฐ',
            price: 299,
            description: 'ะะตะพะณัะฐะฝะธัะตะฝะฝัะต ะะ-ัะตัะตะฟัั ะฝะฐ 30 ะดะฝะตะน'
        }
    };
    
    const selectedPlan = plans[plan];
    
    if (!selectedPlan) {
        return res.json({ success: false, error: 'ะะตะฒะตัะฝัะน ะฟะปะฐะฝ' });
    }
    
    // ะ ัะตะฐะปัะฝะพะผ ะฟัะธะปะพะถะตะฝะธะธ ะทะดะตัั ะฑัะดะตั ะธะฝัะตะณัะฐัะธั ั DonationAlerts API
    // ะะพะบะฐ ะฒะพะทะฒัะฐัะฐะตะผ ะดะฐะฝะฝัะต ะดะปั ัััะฝะพะน ะพะฑัะฐะฑะพัะบะธ
    res.json({
        success: true,
        plan: selectedPlan,
        instructions: `ะะฟะปะฐัะธัะต ${selectedPlan.price}โฝ ะธ ะฝะฐะฟะธัะธัะต ะฝะฐะผ ะฒ WhatsApp ะดะปั ะฐะบัะธะฒะฐัะธะธ`,
        whatsapp: 'https://wa.me/996774032150',
        manualActivation: true
    });
});

// API: Health check
app.get('/health', (req, res) => {
    res.json({ 
        status: 'ok', 
        timestamp: new Date().toISOString(),
        products: Object.values(PRODUCTS_BY_CATEGORY).reduce((a, b) => a + b.length, 0),
        recipes: RECIPES_DB.length,
        gemini: geminiAvailable
    });
});

app.get('/', (req, res) => {
    res.sendFile(path.join(__dirname, 'public', 'index.html'));
});

// 404 handler
app.use('*', (req, res) => {
    res.status(404).sendFile(path.join(__dirname, 'public', 'index.html'));
});

app.listen(PORT, () => {
    console.log(`
    ๐ FridgeChef ะทะฐะฟััะตะฝ!
    ๐ ะะพะผะตะฝ: http://localhost:${PORT}
    ๐ณ ะัะพะดัะบัะพะฒ: ${Object.values(PRODUCTS_BY_CATEGORY).reduce((a, b) => a + b.length, 0)}
    ๐ ะะตัะตะฟัะพะฒ: ${RECIPES_DB.length}
    ๐ค Gemini API: ${geminiAvailable ? 'โ ะะพะดะบะปััะตะฝ' : 'โ ะะต ะฟะพะดะบะปััะตะฝ'}
    `);
});
